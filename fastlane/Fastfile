# Customise this file, documentation can be found here:
# https://github.com/krausefx/fastlane#customise-the-fastfile
# vim: ft=ruby

# Since this file is eval'd, we need to add this file's directory to $LOAD_PATH
$:.unshift File.dirname(__FILE__)

require 'lib/utils.rb'

ENV['WMF_VERSION_NUMBER'] ||= get_version_short_string File.expand_path(File.join(ENV['PWD'], 'Wikipedia/Wikipedia-Info.plist'))

before_all do
  p ENV
end

lane :test do
  make 'lint'
  run_unit_tests
end

lane :alpha do
  ensure_git_status_clean

  run_unit_tests

  # Download the Certificate for signing
  cert

  # Create and/or download the right provisioning profile
  sigh({
    force: true,
    provisioning_name: 'TF Alpha',
    app_identifier: 'org.wikimedia.wikipedia.tfalpha',
  })

  # Create the app in iTunes Connect if needed
  produce({
    produce_username: ENV['WMF_APPLE_USER_NAME'],
    produce_app_identifier: 'org.wikimedia.wikipedia.tfalpha',
    produce_app_identifier_suffix: '', #work around for: https://github.com/KrauseFx/produce/issues/27
    produce_app_name: 'Wikipedia Alpha',
    produce_language: 'English',
    produce_version: ENV['WMF_VERSION_NUMBER'],
    produce_sku: '01985',
  })

  deploy_testflight_build 'Wikipedia Alpha', 'Alpha'
end

lane :beta do
  ensure_git_status_clean

  run_unit_tests

  # Download the Certificate for signing
  cert

  # Create and/or download the right provisioning profile
  sigh({
    force: true,
    provisioning_name: 'TF Beta',
    app_identifier: 'org.wikimedia.wikipedia.tfbeta',
  })

  # Create the app in iTunes Connect if needed
  produce({
    produce_username: ENV['WMF_APPLE_USER_NAME'],
    produce_app_identifier: 'org.wikimedia.wikipedia.tfbeta',
    produce_app_identifier_suffix: '', #work around for: https://github.com/KrauseFx/produce/issues/27
    produce_app_name: 'Wikipedia Beta',
    produce_language: 'English',
    produce_version: ENV['WMF_VERSION_NUMBER'],
    produce_sku: '01984',
  })

  deploy_testflight_build 'Wikipedia Beta', 'Beta'
end

# Untested!
lane :appstore do
  ensure_git_status_clean

  run_unit_tests

  # Download the Certificate for signing
  cert

  # Create and/or download the right provisioning profile
  sigh({
    provisioning_name: 'org.wikimedia.wikipedia AppStore',
    app_identifier: 'org.wikimedia.wikipedia',
  })

  # Create the app in iTunes Connect if needed
  produce({
    produce_username: ENV['WMF_APPLE_USER_NAME'],
    produce_app_identifier: 'org.wikimedia.wikipedia',
    produce_app_identifier_suffix: '', #work around for: https://github.com/KrauseFx/produce/issues/27
    produce_app_name: 'Wikipedia Mobile',
    produce_language: 'English',
    produce_version: ENV['WMF_VERSION_NUMBER'],
    produce_sku: '01982',
  })

  # Set variables for building and distributing
  ENV['IPA_BUILD_SCHEME'] = 'Wikipedia'
  ENV['IPA_BUILD_CONFIG'] = 'Release'
  ENV['APP_APPLE_ID'] = '324715238'

  deploy_appstore_build
end
# after_all do |lane|
# end

# error do |lane, exception|
# end
